<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Snippet {snippet.title}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
          integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <link rel="stylesheet" href="css/styles.css">

</head>
<body>
<div class="bg-light p-5 rounded-lg m-3">

    <h1>{snippet.title}</h1>
    <form id="snippet" class="m-0 border-0">
        <div class="mb-3">
            <label for="title" class="form-label">Title</label>
            <input type="text" id="title" value="{snippet.title}" class="form-control">
        </div>
        <div class="mb-3">
            <label for="fileName" class="form-label">File Name</label>
            <input type="text" id="fileName" value="{snippet.files.get(0).name}" class="form-control">
        </div>
        <div class="mb-3">
            <label for="fileContent" class="form-label">File Content</label>
            <textarea id="fileContent" class="form-control" >{snippet.files.get(0).content}</textarea>
        </div>
        {#if snippet.comments.size > 0}
            <div class="mb-3">
            <label for="comment" class="form-label">Comment</label>
            <input type="text" id="comment" class="form-control" value="{snippet.comments.get(0).content}"/>
            </div>
        {/if}
        {#if snippet.owner == userId }
            <input type="submit" id="formSubmit" class="form-control btn btn-primary" value="Save changes"/>
            <input type="button" id="my-snips" class="form-control btn btn-secondary" value="Back to my snippets"/>
            <input type="button" id="del-snip" class="form-control btn btn-danger" value="Delete this Snippet"/>

        {/if}

    </form>
</div>
</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        crossorigin="anonymous"></script>
<script type="module">
    import { snippet_auth, delSnippet, createFile, createComment, updateSnippet } from "{codeSnippetApiURL}/js/snippet.js"

    var changed = false;
    for (let elt of document.querySelectorAll("input, textarea")) {
        elt.addEventListener("change", function () {
            changed = true;
        })
    }

    snippet_auth("{codeSnippetApiURL}");
    document.getElementById("snippet").addEventListener("submit", function (evt) {
        evt.preventDefault();
        let title = document.getElementById("title").value;
        let fileName = document.getElementById("fileName").value;
        let fileContent = document.getElementById("fileContent").value;
        let comment = "";
        if (document.getElementById("comment") != undefined) {
            comment = document.getElementById("comment").value;
        }


        let files = [createFile(fileName, fileContent)];
        let comments = [createComment(comment)];
        updateSnippet("{snippet.id}", title, files, comments).then(response => {
            if (response.ok) {
                console.log(response);
                location.reload();
            } else {
                alert("something when wrong " + response.blob());
            }
        });
    });

    document.getElementById("del-snip").addEventListener("click", function () {
        let confirm = window.confirm("are your sure you want to remove this snippet?");
        if (confirm) {
            delSnippet("{snippet.id}").then(() => window.location = "/user/me");
        }
    });

    document.getElementById("my-snips").addEventListener("click", function () {
        if(!changed || window.confirm("drop changes to this snippet?")){
                    window.location = "/user/me";
        }
    });
</script>
</html>